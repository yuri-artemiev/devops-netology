
# Домашнее задание к занятию "Микросервисы: принципы"

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- Маршрутизация запросов к нужному сервису на основе конфигурации
- Возможность проверки аутентификационной информации в запросах
- Обеспечение терминации HTTPS

Обоснуйте свой выбор.

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- Поддержка кластеризации для обеспечения надежности
- Хранение сообщений на диске в процессе доставки
- Высокая скорость работы
- Поддержка различных форматов сообщений
- Разделение прав доступа к различным потокам сообщений
- Простота эксплуатации

Обоснуйте свой выбор.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- Хранит загруженные файлы в бакете images
- S3 протокол

**uploader**
- Принимает файл, если он картинка сжимает и загружает его в minio
- POST /v1/upload

**security**
- Регистрация пользователя POST /v1/user
- Получение информации о пользователе GET /v1/user
- Логин пользователя POST /v1/token
- Проверка токена GET /v1/token/validation

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
- Анонимный доступ.
- Запрос направляется в сервис security POST /v1/user

**POST /v1/token**
- Анонимный доступ.
- Запрос направляется в сервис security POST /v1/token

**GET /v1/user**
- Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/
- Запрос направляется в сервис security GET /v1/user

**POST /v1/upload**
- Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/
- Запрос направляется в сервис uploader POST /v1/upload

**GET /v1/user/{image}**
- Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/
- Запрос направляется в сервис minio  GET /images/{image}

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизаци
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

# API Gateway 

- Kong Gateway
- Tyk
- Ocelot
- Goku
- Express API Gateway
- Gloo
- KrakenD
- Fusio
- WSO2
- Apigee
- Cloud Endpoints
- Amazon API Gateway
- Azure API Gateway

| Имя | Kong | Tyk | APIGee | Express Gateway |
| --- | --- | --- | --- | --- | --- | --- | 
| Компоненты системы | Одна нода | Одна нода | Много нод с разными ролями |  Много нод |
| Система хранения | Cassandra или Postgres | Redis | Cassandra, Zookeeper, и Postgres |  Redis |
| Основан на языке | NGINX/Lua | GoLang | Java |  Node.js Express |
| Авторизация | Да | Да | Да | Да |
| Регулирование скорости | Да | Да | Да |  Да |

| Имя | Kong Gateway | Tyk | Express Gateway | Apigee |
| Маршрутизация запросов | Kong Gateway позволяет создавать несколько маршрутов и направлять их к различным восходящим сервисам. Можно задать расширенные правила для маршрутизации запросов к определенным восходящим потокам на основе пути запроса, методов HTTP и заголовков. | Tyk.io позволяет настраивать маршруты с заданными пользователем свойствами, такими как пути, имена хостов, методы и конфигурация заголовков. Tyk также поддерживает подстановочные пути для таких случаев использования, как CORS и проверка HTTP-методов для обеспечения четкого определения и безопасности других API. | Express Gateway позволяет администраторам быстро настраивать точные правила доступа и разрешения для каждого маршрута и легко соединять потребителей и поставщиков API таким образом, чтобы способствовать повторному и многократному использованию. | Apigee позволяет легко настраивать запросы с помощью правил URL с различными критериями, включая методы HTTP и адресацию путей. Он также может проверять форматы входных и выходных данных. |
| Аутентификация в запросах | Kong Gateway предоставляет расширяемый набор плагинов аутентификации для проверки действительных учетных данных для входящих запросов. Сюда входит базовая аутентификация, OAuth2, аутентификация JWT, аутентификация по клиентскому сертификату и многое другое. | Tyk.io поддерживает аутентификацию JWT, чтобы пользователи могли легко авторизировать входящие запросы на своем экземпляре шлюза Tyk. Tyk также поддерживает клиент-серверную разработку OAuth и возможности OpenID Connect, чтобы разработчики могли создавать решения, взаимодействующие с внешними системами идентификации. | Express Gateway обеспечивает проверку пользователя по нескольким источникам, таким как JWT, basic auth или явные токены, которые передаются микросервису. | Apigee имеет встроенную поддержку Oauth 2.0, Basic Auth и API Key, что позволяет администраторам защищать API. Он поддерживает интеграцию с внешними поставщиками идентификационных данных, такими как Auth0, Okta или IdP-клиенты. |
| Терминация HTTPS | Kong Gateway поддерживает разгрузку TLS/SSL с помощью плагина SSL connectivity. Вы можете легко настроить плагин для обеспечения безопасных запросов к вашему API или веб-сайту без внесения каких-либо изменений в существующий код. | Порт Tyk.io 443 поддерживает завершение HTTPS-трафика от конечной точки внутреннего сервиса до внешнего включенного SSL-обработчика для дополнительных настроек безопасности при взаимодействии с внешними публичными веб-сервисами или частными конечными точками RESTful. | Express Gateway Окончание HTTPS позволяет настраивать сертификаты на уровне шлюза, обеспечивая безопасную связь между клиентами и их API. | Apigee поддерживает прекращение входящего и исходящего трафика SSL/TLS с помощью политик, которые обеспечивают безопасную связь между клиентскими приложениями и API на всех уровнях стека. |





# Брокер сообщений

- Apache Kafka
- RabbitMQ
- Apache ActiveMQ
- Redis

| Name | Apache Kafka | RabbitMQ | Apache ActiveMQ |
|---|---|---|
| Кластеризация | Apache Kafka поддерживает распределенную установку (кластер Kafka) с высокой доступностью и автоматической репликацией данных на несколько узлов. | RabbitMQ также обеспечивает кластерную установку с высокой доступностью за счет зеркалирования очередей на узлах сервера RabbitMQ. | ActiveMQ поддерживает активные/активные кластеры или несколько "мастер-узлов", которые могут работать вместе для обеспечения отказоустойчивости в случае отказа узла. |
| Хранение сообщений на диске | сообщения в Apache Kafka долго хранятся на диске. | сообщения в RabbitMQ долго хранятся на диске. | ActiveMQ сохраняет сообщения на диск для долгосрочного хранения и предоставляет несколько различных вариантов хранения сообщений, включая KahaDB, JDBC и журналирование AMQ3. |
| Скорость работы | Apache Kafka предлагает очень хорошую производительность для операций публикации и подписки. | RabbitMQ хорош в обеспечении надежной доставки сообщений, но его производительность отстает от Apache Kafka при работе с большими объемами данных или высокой пропускной способностью. RabbitMQ не обеспечивает передачу сообщений с низкой задержкой, как Apache Kafka, что ограничивает его применение в потоковых приложениях. |  ActiveMQ поддерживает ограничение соединения, настраиваемый максимальный размер сообщения, асинхронную отправку/получение и долговечные структуры памяти для индексированного поиска. |
| Форматы сообщений | Apche Kafka поддерживает несколько различных форматов сообщений, таких как простой текст, Avro, Protobuf и другие. | RabbitMQ поддерживает обычный текст или формат JSON, а также некоторые другие, включая бинарные файлы, такие как изображения и видео. | ActiveMQ поддерживает множество форматов обмена сообщениями, включая JMS 1.1 и 2.0, TextMessages (XML), MapMessages (JSON), StreamMessage (бинарный), а также любые пользовательские форматы с помощью модулей Foreign Format Adapter (FFA). |
| Права доступа к сообщениям | Apache Kafka обеспечивает контроль доступа с помощью ACL (списков контроля доступа), которые определяют разрешения на доступ на основе идентификации пользователя или адреса хоста.  | RabbitMQ также использует ACL (списки контроля доступа) для управления разрешениями доступа к очередям сообщений путем назначения ролей пользователей или определенных ресурсов, таких как разрешения на чтение/запись и т.д. | Доступ к брокеру сообщений регулируется с помощью функции списков контроля доступа Apache ActiveMQ, которая позволяет детально определить пользователей и роли с правами на публикацию или подписку сообщений. |





| Имя | RabbitMQ | Kafka |
| --- | --- |
| Формирование порядка сообщений | Не поддерживается | Используется ключ сообщения |
| Приоритет сообщений | Поддерживается | Не поддерживается |
| Повторное проигрывание сообщений | Нет, сообщение удаляется после доставки | Поддерживается |
| Аутентификация | Поддерживается | Поддерживается |